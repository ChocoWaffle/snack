<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N빵 계산기</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        h1 {
            color: #1e293b;
            font-size: 1.75rem;
            margin-bottom: 5px; /* 서브 제목과의 간격 조절 */
            font-weight: 700;
        }

        .subtitle {
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .payer-input-container {
            width: 100%;
        }

        .payer-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fafbfd;
            border-radius: 8px;
            border: 1px solid #eef2f6;
        }
        
        .payer-input-group .row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .payer-input-group .row > div {
            flex: 1;
            text-align: left;
        }
        
        .payer-input-group label {
            display: block;
            margin-bottom: 5px;
            color: #475569;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .payer-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 500;
        }

        .input-group input:focus, .payer-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .button {
            width: 100%;
            padding: 14px;
            background-color: #2563eb;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            margin-bottom: 10px;
        }
        
        .button.secondary-button {
            background-color: #475569;
        }
        
        .button.secondary-button:hover {
            background-color: #334155;
        }

        .button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }
        
        .add-button {
            background-color: #10b981;
        }

        .add-button:hover {
            background-color: #059669;
        }

        .remove-button {
            padding: 10px 12px;
            background-color: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .remove-button:hover {
            background-color: #dc2626;
        }
        
        .result-box {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
            word-break: break-all;
        }
        
        .result-box ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .result-box h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #1e293b;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 8px;
        }

        .result-box li {
            margin-bottom: 10px;
            color: #334155;
            line-height: 1.5;
            font-weight: 500;
        }

        .result-box li:last-child {
            margin-bottom: 0;
        }

        .error-message {
            color: #ef4444;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        .balance-info {
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 15px;
            text-align: center;
        }
        .final-balance {
            font-weight: bold;
        }
        .final-balance.positive {
            color: #10b981;
        }
        .final-balance.negative {
            color: #ef4444;
        }
        .highlight {
            background-color: #fff9c4; /* 연한 노란색 하이라이트 */
            transition: background-color 0.3s ease;
        }
        .highlight-add {
            background-color: #c8e6c9; /* 연한 녹색 하이라이트 */
            transition: background-color 0.3s ease;
        }
        .highlight-sub {
            background-color: #ffcdd2; /* 연한 빨간색 하이라이트 */
            transition: background-color 0.3s ease;
        }

        .status-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        /* 추가된 스타일: 버튼들 사이의 간격 */
        .result-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <div class="container">
        <h1>파워 N빵 계산기</h1>
        <p class="subtitle">그러게 한 사람이 몰빵해서 계산하자 했잖아</p>
        <div class="input-group">
            <label for="totalPeople">총 인원수 (N)</label>
            <input type="number" id="totalPeople" placeholder="전체 인원" min="1" required>
        </div>
        <div class="payer-input-container" id="dynamicInputs">
            <!-- 지불자 입력란이 여기에 동적으로 추가됩니다 -->
        </div>
        <button class="button add-button" onclick="addPayer()">지불자 추가</button>
        <button class="button" onclick="calculate()">계산하기</button>
        <div id="result-container">
            <div class="result-box" id="result">
                <p>결과가 여기에 표시됩니다.</p>
            </div>
            <!-- 복사 버튼과 상태 메시지가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script>
        // 고유한 지불자 ID를 위한 카운터
        let payerCount = 0;

        /**
         * 새로운 지불자 이름, 금액, 대상 인원 입력란을 동적으로 추가합니다.
         */
        function addPayer() {
            payerCount++;
            const dynamicInputs = document.getElementById('dynamicInputs');
            const newPayerDiv = document.createElement('div');
            newPayerDiv.className = 'payer-input-group';
            newPayerDiv.dataset.id = payerCount;
            
            newPayerDiv.innerHTML = `
                <div class="row">
                    <div>
                        <label for="name-${payerCount}">이름</label>
                        <input type="text" id="name-${payerCount}" class="payer-name" placeholder="지불자 ${payerCount}" value="지불자 ${payerCount}" lang="ko" autofocus>
                    </div>
                    <div>
                        <label for="amount-${payerCount}">금액</label>
                        <input type="number" id="amount-${payerCount}" class="payer-amount" placeholder="금액" min="0" required>
                    </div>
                    <button class="remove-button" onclick="removePayer(this)">제거</button>
                </div>
                <div>
                    <label for="target-${payerCount}">대상 인원 (이름:비율, 이름:비율...)</label>
                    <input type="text" id="target-${payerCount}" class="payer-target" placeholder="예: '철수:20, 영희:80' 혹은 '철수, 영희' (쉼표로 구분)" lang="ko">
                </div>
            `;
            
            dynamicInputs.appendChild(newPayerDiv);
        }

        /**
         * 동적 입력 그룹을 제거합니다.
         * @param {HTMLElement} button - 클릭된 제거 버튼 요소
         */
        function removePayer(button) {
            const payerInputGroup = button.closest('.payer-input-group');
            if (payerInputGroup) {
                payerInputGroup.remove();
            }
        }

        /**
         * 이름을 CSS 선택자 친화적인 형식으로 변환합니다.
         * 공백과 특수 문자를 하이픈으로 대체합니다.
         * @param {string} name - 원본 이름
         * @returns {string} 변환된 이름
         */
        function getSanitizedName(name) {
            // 공백과 특수 문자를 하이픈으로 대체합니다.
            return name.replace(/\s+/g, '-').replace(/[^\w\-가-힣ㄱ-ㅎㅏ-ㅣ]/g, '');
        }

        /**
         * 마우스 오버 시 Matrix 1의 소스 셀을 하이라이트합니다.
         * @param {string} from - 지불자 이름 (Matrix 2의 행)
         * @param {string} to - 받을 사람 이름 (Matrix 2의 열)
         */
        function highlightSources(from, to) {
            console.info(`from : ${from}', to : ${to}`)
            // Matrix 2 셀의 계산 공식: matrix2[from][to] = matrix1[to][from] - matrix1[from][to]
            // 따라서 하이라이트할 Matrix 1 셀은 matrix1[to][from]과 matrix1[from][to] 입니다.
            const sanitizedFrom = getSanitizedName(from);
            const sanitizedTo = getSanitizedName(to);
            
            const cell1 = document.querySelector(`#matrix1-cell-${sanitizedTo}-${sanitizedFrom}`);
            const cell2 = document.querySelector(`#matrix1-cell-${sanitizedFrom}-${sanitizedTo}`);

            if (cell1) {
                cell1.classList.add('highlight-add');
            }
            if (cell2) {
                cell2.classList.add('highlight-sub');
            }
        }

        /**
         * 마우스 아웃 시 Matrix 1의 하이라이트를 제거합니다.
         * @param {string} from - 지불자 이름 (Matrix 2의 행)
         * @param {string} to - 받을 사람 이름 (Matrix 2의 열)
         */
        function removeHighlight(from, to) {
            const sanitizedFrom = getSanitizedName(from);
            const sanitizedTo = getSanitizedName(to);
            
            const cell1 = document.querySelector(`#matrix1-cell-${sanitizedTo}-${sanitizedFrom}`);
            const cell2 = document.querySelector(`#matrix1-cell-${sanitizedFrom}-${sanitizedTo}`);

            if (cell1) {
                cell1.classList.remove('highlight-add');
            }
            if (cell2) {
                cell2.classList.remove('highlight-sub');
            }
        }
        
        /**
         * Matrix 2 셀에서 마우스 아웃 시 호출되는 이벤트 핸들러
         */
        function handleMouseOut(event) {
            const targetCell = event.target.closest('td');
            if (targetCell && targetCell.dataset.row && targetCell.dataset.col) {
                const from = targetCell.dataset.row;
                const to = targetCell.dataset.col;
                removeHighlight(from, to);
            }
        }

        /**
         * 계산이 완료된 결과 내용을 이미지로 다운로드합니다.
         */
        async function downloadResultAsImage() {
            const resultBox = document.getElementById('result');
            const statusMessage = document.getElementById('copy-status');
            
            if (!resultBox) {
                return;
            }

            statusMessage.textContent = '이미지 생성 중...';

            try {
                // html2canvas를 사용하여 result-box를 캔버스에 렌더링
                const canvas = await html2canvas(resultBox, {
                    scale: 2, // 고해상도 이미지 생성을 위해 스케일 증가
                    backgroundColor: '#f8fafc', // 배경색 지정
                    useCORS: true // CORS 설정
                });

                // 캔버스 데이터를 다운로드 가능한 URL로 변환
                const imageUrl = canvas.toDataURL('image/png');
                
                // 다운로드를 위한 임시 링크 생성
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = 'n빵_정산_결과.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusMessage.textContent = '이미지 다운로드가 시작되었습니다!';
                setTimeout(() => statusMessage.textContent = '', 3000);

            } catch (err) {
                console.error('Failed to download image: ', err);
                statusMessage.textContent = '이미지 다운로드 실패.';
            }
        }

        /**
         * 최종 정산 결과 텍스트를 클립보드에 복사합니다.
         */
        function copyResultAsText() {
            const resultList = document.querySelector('#result ul');
            const statusMessage = document.getElementById('copy-status');
            
            if (!resultList) {
                statusMessage.textContent = '복사할 텍스트가 없습니다.';
                return;
            }
            
            const textToCopy = resultList.innerText;
            
            // 텍스트를 임시 요소에 넣고 복사
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                statusMessage.textContent = '텍스트가 클립보드에 복사되었습니다!';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                statusMessage.textContent = '텍스트 복사 실패.';
            }
            
            document.body.removeChild(tempTextArea);
            setTimeout(() => statusMessage.textContent = '', 3000);
        }

        /**
         * 정산을 계산하는 메인 함수.
         * 모든 동적 입력값을 읽어 잔액을 계산하고 정산 내역을 표시합니다.
         */
        function calculate() {
            const totalPeople = parseInt(document.getElementById('totalPeople').value);
            const resultContainer = document.getElementById('result-container');
            resultContainer.innerHTML = `
                <div class="result-box" id="result">
                    <p>결과가 여기에 표시됩니다.</p>
                </div>
            `;
            const resultDiv = document.getElementById('result');
            
            const errors = []; // 오류를 담을 배열

            if (isNaN(totalPeople) || totalPeople <= 0) {
                errors.push('총 인원수를 올바르게 입력해주세요.');
            }

            const payerInputs = document.querySelectorAll('.payer-input-group');
            
            const payments = [];
            const allPayerNames = new Set();
            
            // 입력값 유효성 검사 및 데이터 수집
            for (const inputDiv of payerInputs) {
                const name = inputDiv.querySelector('.payer-name').value.trim();
                const amount = parseInt(inputDiv.querySelector('.payer-amount').value);
                const targetString = inputDiv.querySelector('.payer-target').value.trim();

                if (isNaN(amount) || amount < 0) {
                    errors.push(`<b>${name || '익명'}</b>의 금액을 올바르게 입력해주세요.`);
                }
                
                allPayerNames.add(name);
                payments.push({
                    name: name,
                    amount: amount,
                    targetString: targetString
                });
            }

            if (payments.length === 0) {
                errors.push('최소 한 명의 지불자를 추가하고 금액을 입력해주세요.');
            }
            
            // 오류가 하나라도 있으면 모든 오류 메시지를 표시하고 종료
            if (errors.length > 0) {
                let errorHtml = '<p class="error-message"><b>계산 오류:</b></p><ul>';
                errors.forEach(err => {
                    errorHtml += `<li>${err}</li>`;
                });
                errorHtml += '</ul>';
                resultDiv.innerHTML = errorHtml;
                return;
            }

            // 모든 참여자의 이름을 통합하여 배열 생성
            let allParticipants = Array.from(allPayerNames);
            payments.forEach(p => {
                p.targetString.split(',').map(s => s.trim()).filter(s => s.length > 0).forEach(targetName => {
                    const nameOnly = targetName.split(':')[0].trim();
                    if (nameOnly) allParticipants.push(nameOnly);
                });
            });
            allParticipants = [...new Set(allParticipants)]; // 중복 제거

            // 총 인원수(N)와 참여자 수 비교하여 가상의 참여자 추가
            while (allParticipants.length < totalPeople) {
                allParticipants.push(`참석자 ${allParticipants.length + 1}`);
            }

            // 각 지출에 대한 개인별 분담금액을 계산하는 1차 행렬 (Matrix 1)
            const matrix1 = {};
            allParticipants.forEach(p1 => {
                matrix1[p1] = {};
                allParticipants.forEach(p2 => {
                    matrix1[p1][p2] = 0;
                });
            });

            payments.forEach(p => {
                if (p.targetString.includes(':')) {
                    // 비율로 분담하는 경우: 'A:50, B, C'와 같은 입력
                    const targetParts = p.targetString.split(',').map(s => s.trim());
                    const parsedTargets = {};
                    let totalPercentage = 0;
                    const peopleForRemainingSplit = [];
                    
                    for (const part of targetParts) {
                        const [targetName, ratio] = part.split(':').map(s => s.trim());
                        if (targetName) {
                            if(!isNaN(parseFloat(ratio))){
                                // 명시된 비율이 있는 경우
                                parsedTargets[targetName] = parseFloat(ratio);
                                totalPercentage += parseFloat(ratio);
                            }
                            else{
                                // 비율이 없는 경우 (남은 금액을 N빵으로 분배할 대상)
                                peopleForRemainingSplit.push(targetName);
                            }
                        }
                    }

                    // 1. 명시된 비율로 금액 분배
                    for (const name in parsedTargets) {
                        const cost = p.amount * (parsedTargets[name] / 100);
                        matrix1[p.name][name] += cost;
                    }

                    // 2. 남은 금액을 비율이 없는 사람들에게 N빵으로 분배
                    const remainingAmount = p.amount * (1 - totalPercentage / 100);
                    
                    if (peopleForRemainingSplit.length > 0) {
                        const costPerRemainingHead = remainingAmount / peopleForRemainingSplit.length;
                        peopleForRemainingSplit.forEach(personName => {
                            matrix1[p.name][personName] += costPerRemainingHead;
                        });
                    }

                } else {
                    // 비율이 없는 순수 N빵으로 분담하는 경우: 'A, B, C' 혹은 공백
                    const targetParts = p.targetString.split(',').map(s => s.trim());
                    const effectiveTargets = targetParts.filter(s => s.length > 0);
                    
                    let peopleToCharge;
                    if (effectiveTargets.length > 0) {
                        peopleToCharge = effectiveTargets;
                    } else {
                        // 대상 인원 입력란이 비어있으면 총 인원수(N)로 N빵
                        peopleToCharge = allParticipants;
                    }
                    
                    const costPerHead = p.amount / peopleToCharge.length;
                    
                    peopleToCharge.forEach(personName => {
                        matrix1[p.name][personName] += costPerHead;
                    });
                }
            });

            // 최종 정산 행렬 (Matrix 2)
            const matrix2 = {};
            allParticipants.forEach(p1 => {
                matrix2[p1] = {};
                allParticipants.forEach(p2 => {
                    const value = matrix1[p2][p1] - matrix1[p1][p2];
                    matrix2[p1][p2] = Math.max(0, value);
                });
            });

            // 결과 HTML 생성
            let resultHTML = '<h3>각 지출에 대한 개인별 분담금액 (Matrix 1)</h3>';
            resultHTML += '<table style="width:100%; border-collapse: collapse; text-align: center;" id="matrix1">';
            resultHTML += '<thead><tr><th style="padding: 8px; border: 1px solid #ddd;"></th>' + allParticipants.map(p => `<th style="padding: 8px; border: 1px solid #ddd;">${p}</th>`).join('') + '</tr></thead>';
            resultHTML += '<tbody>';
            allParticipants.forEach(rowP => {
                const sanitizedRowP = getSanitizedName(rowP);
                resultHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;"><b>${rowP}</b></td>`;
                allParticipants.forEach(colP => {
                    const sanitizedColP = getSanitizedName(colP);
                    // 행/열 구성을 역전시켜 '열'이 '행'에게 지불한 금액을 보여줌
                    resultHTML += `<td id="matrix1-cell-${sanitizedRowP}-${sanitizedColP}" style="padding: 8px; border: 1px solid #ddd;">${Math.round(matrix1[colP][rowP]).toLocaleString()}</td>`;
                });
                resultHTML += '</tr>';
            });
            resultHTML += '</tbody></table>';

            resultHTML += '<h3 style="margin-top:20px;">최종 정산 행렬 (Matrix 2)</h3>';
            resultHTML += '<table style="width:100%; border-collapse: collapse; text-align: center;" id="matrix2">';
            resultHTML += '<thead><tr><th style="padding: 8px; border: 1px solid #ddd;"></th>' + allParticipants.map(p => `<th style="padding: 8px; border: 1px solid #ddd;">${p}</th>`).join('') + '</tr></thead>';
            resultHTML += '<tbody>';
            allParticipants.forEach((rowP) => {
                resultHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;"><b>${rowP}</b></td>`;
                allParticipants.forEach((colP) => {
                    const amount = Math.round(matrix2[rowP][colP]);
                    const cellAttributes = `data-row="${rowP}" data-col="${colP}"`;
                    const cellStyle = amount > 0 ? `cursor: pointer;` : '';
                    resultHTML += `<td ${cellAttributes} style="padding: 8px; border: 1px solid #ddd;${cellStyle}">${amount.toLocaleString()}</td>`;
                });
                resultHTML += '</tr>';
            });
            resultHTML += '</tbody></table>';

            resultHTML += '<h3 style="margin-top:20px;">최종 정산 결과</h3><ul>';
            let transactionsExist = false;
            allParticipants.forEach(fromP => {
                allParticipants.forEach(toP => {
                    const amount = Math.round(matrix2[fromP][toP]);
                    if (amount > 0) {
                        resultHTML += `<li><b>${fromP}</b> &gt; <b>${toP}</b> ${amount.toLocaleString()}원</li>`;
                        transactionsExist = true;
                    }
                });
            });

            if (!transactionsExist) {
                resultHTML += '<li>정산할 금액이 없습니다.</li>';
            }
            resultHTML += '</ul>';

            resultDiv.innerHTML = resultHTML;

            // 계산 후 버튼들 동적 생성 및 추가
            const resultActionsDiv = document.createElement('div');
            resultActionsDiv.className = 'result-actions';
            
            const downloadButton = document.createElement('button');
            downloadButton.className = 'button secondary-button';
            downloadButton.textContent = '이미지로 저장';
            downloadButton.onclick = downloadResultAsImage;
            
            const copyTextButton = document.createElement('button');
            copyTextButton.className = 'button secondary-button';
            copyTextButton.textContent = '정산 결과 텍스트 복사';
            copyTextButton.onclick = copyResultAsText;

            const statusMessage = document.createElement('p');
            statusMessage.id = 'copy-status';
            statusMessage.className = 'status-message';
            
            resultActionsDiv.appendChild(downloadButton);
            resultActionsDiv.appendChild(copyTextButton);
            resultContainer.appendChild(resultActionsDiv);
            resultContainer.appendChild(statusMessage);


            // 이벤트 위임을 사용하여 Matrix 2 테이블에만 리스너를 추가합니다.
            const matrix2Table = document.getElementById('matrix2');
            if (matrix2Table) {
                matrix2Table.addEventListener('mouseover', handleMouseOver);
                matrix2Table.addEventListener('mouseout', handleMouseOut);
            }
        }

        /**
         * Matrix 2 셀에 마우스 오버 시 호출되는 이벤트 핸들러
         */
        function handleMouseOver(event) {
            const targetCell = event.target.closest('td');
            if (targetCell && targetCell.dataset.row && targetCell.dataset.col) {
                const from = targetCell.dataset.row;
                const to = targetCell.dataset.col;
                const amount = parseInt(targetCell.textContent.replace(/,/g, ''));
                highlightSources(from, to);
            }
        }

        // 함수가 정의된 후 호출되도록 위치를 변경합니다.
        addPayer();
    </script>
</body>
</html>
