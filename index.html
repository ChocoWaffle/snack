<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N빵 계산기</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative; /* 팝업을 위한 상대 위치 설정 */
        }

        h1 {
            color: #1e293b;
            font-size: 1.75rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .subtitle {
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .payer-input-container {
            width: 100%;
        }

        .payer-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fafbfd;
            border-radius: 8px;
            border: 1px solid #eef2f6;
        }
        
        .payer-input-group .row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .payer-input-group .row > div {
            flex: 1;
            text-align: left;
        }
        
        .payer-input-group label {
            display: block;
            margin-bottom: 5px;
            color: #475569;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .payer-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            cursor: pointer;
        }

        .payer-input-group input[type="number"] {
            cursor: text;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .input-group input:focus, .input-group textarea:focus, .payer-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .button {
            width: 100%;
            padding: 14px;
            background-color: #2563eb;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            margin-bottom: 10px;
        }
        
        .button.secondary-button {
            background-color: #475569;
        }
        
        .button.secondary-button:hover {
            background-color: #334155;
        }

        .button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }
        
        .add-button {
            background-color: #10b981;
        }

        .add-button:hover {
            background-color: #059669;
        }

        .remove-button {
            padding: 10px 12px;
            background-color: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .remove-button:hover {
            background-color: #dc2626;
        }
        
        .result-box {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
            word-break: break-all;
        }
        
        .result-box ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .result-box h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #1e293b;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 8px;
        }

        .result-box li {
            margin-bottom: 10px;
            color: #334155;
            line-height: 1.5;
            font-weight: 500;
        }

        .result-box li:last-child {
            margin-bottom: 0;
        }

        .error-message {
            color: #ef4444;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .highlight-add {
            background-color: #c8e6c9;
            transition: background-color 0.3s ease;
        }
        .highlight-sub {
            background-color: #ffcdd2;
            transition: background-color 0.3s ease;
        }

        .status-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .result-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .help-section {
            background-color: #f1f5f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.5;
        }
        
        .help-section summary {
            font-weight: 600;
            color: #1e293b;
            cursor: pointer;
            outline: none;
            list-style: none;
            position: relative;
            padding-left: 1.5em;
        }
        
        .help-section summary::before {
            content: '+';
            font-size: 1.5em;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease-in-out;
        }
        
        .help-section[open] summary::before {
            content: '-';
            transform: translateY(-50%);
        }
        
        .help-section ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
        }
        
        .help-section li {
            margin-bottom: 5px;
            color: #475569;
        }
        
        .help-section ul ul {
            padding-left: 10px;
            border-left: 2px solid #cbd5e1;
            margin-top: 5px;
            list-style-type: '• ';
        }

        /* 팝업 관련 스타일 */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }

        .popup-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .popup {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
        }

        .popup.visible {
            transform: scale(1);
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .popup-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #94a3b8;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #64748b;
        }
        
        .popup-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .popup-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .popup-list-item:hover {
            background-color: #f1f5f9;
        }

        .popup-list-item input[type="radio"] {
            margin-right: 10px;
        }

        .popup-list-item label {
            flex-grow: 1;
            cursor: pointer;
        }

        /* Target Popup 전용 스타일 */
        .target-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .target-item input[type="checkbox"] {
            width: auto;
            margin-right: 0;
        }

        .target-item label {
            flex-grow: 1;
            font-weight: 500;
        }

        .target-item input[type="number"] {
            width: 80px;
            text-align: right;
            padding: 6px 10px;
            font-size: 0.9rem;
        }
        
        .target-item.selected {
            background-color: #e0f2fe;
        }
        
        .popup-actions {
            margin-top: 15px;
        }

    </style>
</head>
<body>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <div class="container">
        <h1>파워 N빵 계산기</h1>
        <p class="subtitle">그러게 한 사람이 몰빵해서 계산하자 했잖아</p>

        <details class="help-section">
            <summary>사용 방법</summary>
            <ul>
                <li><b>전체 참여자:</b> 정산에 참여할 모든 사람들의 이름을 쉼표(,)로 구분하여 입력합니다. (예: 철수, 영희, 민지)</li>
                <li><b>지불자 추가:</b> 버튼을 눌러 비용을 지불한 사람들을 추가합니다.</li>
                <li><b>이름/대상 인원:</b> 해당 입력란을 클릭하면 미리 입력한 전체 참여자 목록에서 간편하게 선택할 수 있습니다.</li>
                <li><b>금액:</b> 지불한 금액을 입력합니다.</li>
                <li><b>대상 인원:</b> 이 비용을 나누어 낼 사람들을 지정합니다. 팝업에서 여러 명을 선택하고, 각자 부담할 비율을 입력할 수 있습니다. (비율 미입력 시 N빵) (대상 인원을 아무도 선택하지 않으면 전체 참여자에게 N빵으로 분배됩니다.)</li>
                <li><b>계산하기:</b> 입력된 내용을 바탕으로 정산을 계산하고, 각자 얼마를 내고 받는지 결과를 보여줍니다.</li>
                <li><b>결과 확인:</b> <b>최종 정산 행렬</b>에서 마우스를 올리면 어떤 지출 때문에 금액이 오고 가는지 보여줍니다.</li>
                <li><b>이미지로 저장:</b> 최종 정산 결과를 이미지 파일로 다운로드합니다.</li>
                <li><b>텍스트 복사:</b> 최종 정산 결과 텍스트만 클립보드에 복사합니다.</li>
            </ul>
        </details>

        <div class="input-group">
            <label for="allParticipants">전체 참여자 이름 (쉼표로 구분)</label>
            <textarea id="allParticipants" rows="2" placeholder="예: 철수, 영희, 민지" lang="ko"></textarea>
        </div>
        <div class="payer-input-container" id="dynamicInputs">
            <!-- 지불자 입력란이 여기에 동적으로 추가됩니다 -->
        </div>
        <button class="button add-button" onclick="addPayer()">지불자 추가</button>
        <button class="button" onclick="calculate()">계산하기</button>
        <div id="result-container">
            <div class="result-box" id="result">
                <p>결과가 여기에 표시됩니다.</p>
            </div>
            <!-- 복사 버튼과 상태 메시지가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>
    
    <!-- 지불자 이름 선택 팝업 -->
    <div id="payerNamePopupOverlay" class="popup-overlay">
        <div class="popup" id="payerNamePopup">
            <div class="popup-header">
                <h3>지불자 선택</h3>
                <button class="close-btn" onclick="hidePopup('payerName')">&times;</button>
            </div>
            <div id="payerNameList" class="popup-list"></div>
        </div>
    </div>

    <!-- 대상 인원 선택 팝업 -->
    <div id="targetPopupOverlay" class="popup-overlay">
        <div class="popup" id="targetPopup">
            <div class="popup-header">
                <h3>대상 인원 선택 및 비율 입력</h3>
                <button class="close-btn" onclick="hidePopup('target')">&times;</button>
            </div>
            <div id="targetList" class="popup-list"></div>
            <div class="popup-actions">
                <button class="button" onclick="selectTargets()">선택 완료</button>
            </div>
        </div>
    </div>

    <script>
        // 고유한 지불자 ID를 위한 카운터
        let payerCount = 0;
        let activeInput = null; // 현재 활성화된 입력 필드 추적

        /**
         * 새로운 지불자 이름, 금액, 대상 인원 입력란을 동적으로 추가합니다.
         */
        function addPayer() {
            payerCount++;
            const dynamicInputs = document.getElementById('dynamicInputs');
            const newPayerDiv = document.createElement('div');
            newPayerDiv.className = 'payer-input-group';
            newPayerDiv.dataset.id = payerCount;
            
            newPayerDiv.innerHTML = `
                <div class="row">
                    <div>
                        <label for="name-${payerCount}">이름</label>
                        <input type="text" id="name-${payerCount}" class="payer-name" placeholder="지불자 선택" readonly>
                    </div>
                    <div>
                        <label for="amount-${payerCount}">금액</label>
                        <input type="number" id="amount-${payerCount}" class="payer-amount" placeholder="금액" min="0" required>
                    </div>
                    <button class="remove-button" onclick="removePayer(this)">제거</button>
                </div>
                <div>
                    <label for="target-${payerCount}">대상 인원 (이름:비율, 이름:비율...)</label>
                    <input type="text" id="target-${payerCount}" class="payer-target" placeholder="대상 인원 선택" readonly>
                </div>
            `;
            
            dynamicInputs.appendChild(newPayerDiv);

            // 새로 추가된 입력 필드에 이벤트 리스너 추가
            newPayerDiv.querySelector('.payer-name').addEventListener('click', (e) => showPopup('payerName', e.target));
            newPayerDiv.querySelector('.payer-target').addEventListener('click', (e) => showPopup('target', e.target));
        }

        /**
         * 동적 입력 그룹을 제거합니다.
         * @param {HTMLElement} button - 클릭된 제거 버튼 요소
         */
        function removePayer(button) {
            const payerInputGroup = button.closest('.payer-input-group');
            if (payerInputGroup) {
                payerInputGroup.remove();
            }
        }

        /**
         * 이름을 CSS 선택자 친화적인 형식으로 변환합니다.
         * 공백과 특수 문자를 하이픈으로 대체합니다.
         * @param {string} name - 원본 이름
         * @returns {string} 변환된 이름
         */
        function getSanitizedName(name) {
            return name.replace(/\s+/g, '-').replace(/[^\w\-가-힣ㄱ-ㅎㅏ-ㅣ]/g, '');
        }

        /**
         * 마우스 오버 시 Matrix 1의 소스 셀을 하이라이트합니다.
         * @param {string} from - 지불자 이름 (Matrix 2의 행)
         * @param {string} to - 받을 사람 이름 (Matrix 2의 열)
         */
        function highlightSources(from, to) {
            const sanitizedFrom = getSanitizedName(from);
            const sanitizedTo = getSanitizedName(to);
            
            const cell1 = document.querySelector(`#matrix1-cell-${sanitizedTo}-${sanitizedFrom}`);
            const cell2 = document.querySelector(`#matrix1-cell-${sanitizedFrom}-${sanitizedTo}`);

            if (cell1) {
                cell1.classList.add('highlight-add');
            }
            if (cell2) {
                cell2.classList.add('highlight-sub');
            }
        }

        /**
         * 마우스 아웃 시 Matrix 1의 하이라이트를 제거합니다.
         * @param {string} from - 지불자 이름 (Matrix 2의 행)
         * @param {string} to - 받을 사람 이름 (Matrix 2의 열)
         */
        function removeHighlight(from, to) {
            const sanitizedFrom = getSanitizedName(from);
            const sanitizedTo = getSanitizedName(to);
            
            const cell1 = document.querySelector(`#matrix1-cell-${sanitizedTo}-${sanitizedFrom}`);
            const cell2 = document.querySelector(`#matrix1-cell-${sanitizedFrom}-${sanitizedTo}`);

            if (cell1) {
                cell1.classList.remove('highlight-add');
            }
            if (cell2) {
                cell2.classList.remove('highlight-sub');
            }
        }
        
        /**
         * Matrix 2 셀에서 마우스 아웃 시 호출되는 이벤트 핸들러
         */
        function handleMouseOut(event) {
            const targetCell = event.target.closest('td');
            if (targetCell && targetCell.dataset.row && targetCell.dataset.col) {
                const from = targetCell.dataset.row;
                const to = targetCell.dataset.col;
                removeHighlight(from, to);
            }
        }
        
        /**
         * Matrix 2 셀에 마우스 오버 시 호출되는 이벤트 핸들러
         */
        function handleMouseOver(event) {
            const targetCell = event.target.closest('td');
            if (targetCell && targetCell.dataset.row && targetCell.dataset.col) {
                const from = targetCell.dataset.row;
                const to = targetCell.dataset.col;
                const amount = parseInt(targetCell.textContent.replace(/,/g, ''));
                if (amount > 0) {
                    highlightSources(from, to);
                }
            }
        }

        /**
         * 계산이 완료된 결과 내용을 이미지로 다운로드합니다.
         */
        async function downloadResultAsImage() {
            const resultBox = document.getElementById('result');
            const statusMessage = document.getElementById('copy-status');
            
            if (!resultBox) {
                return;
            }

            statusMessage.textContent = '이미지 생성 중...';

            try {
                // html2canvas를 사용하여 result-box를 캔버스에 렌더링
                const canvas = await html2canvas(resultBox, {
                    scale: 2, // 고해상도 이미지 생성을 위해 스케일 증가
                    backgroundColor: '#f8fafc', // 배경색 지정
                    useCORS: true // CORS 설정
                });

                // 캔버스 데이터를 다운로드 가능한 URL로 변환
                const imageUrl = canvas.toDataURL('image/png');
                
                // 다운로드를 위한 임시 링크 생성
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = 'n빵_정산_결과.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusMessage.textContent = '이미지 다운로드가 시작되었습니다!';
                setTimeout(() => statusMessage.textContent = '', 3000);

            } catch (err) {
                console.error('Failed to download image: ', err);
                statusMessage.textContent = '이미지 다운로드 실패.';
            }
        }

        /**
         * 최종 정산 결과 텍스트를 클립보드에 복사합니다.
         */
        function copyResultAsText() {
            const resultList = document.querySelector('#result ul');
            const statusMessage = document.getElementById('copy-status');
            
            if (!resultList) {
                statusMessage.textContent = '복사할 텍스트가 없습니다.';
                return;
            }
            
            const textToCopy = resultList.innerText;
            
            // 텍스트를 임시 요소에 넣고 복사
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                statusMessage.textContent = '텍스트가 클립보드에 복사되었습니다!';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                statusMessage.textContent = '텍스트 복사 실패.';
            }
            
            document.body.removeChild(tempTextArea);
            setTimeout(() => statusMessage.textContent = '', 3000);
        }

        /**
         * 팝업을 표시하고 내용을 동적으로 생성합니다.
         * @param {string} type - 'payerName' 또는 'target'
         * @param {HTMLElement} inputElement - 클릭된 입력 필드
         */
        function showPopup(type, inputElement) {
            const allParticipantsInput = document.getElementById('allParticipants').value.trim();
            if (!allParticipantsInput) {
                // 경고 메시지 표시 또는 사용자에게 알림
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `<p class="error-message"><b>오류:</b> 전체 참여자 이름을 먼저 입력해주세요.</p>`;
                return;
            }
            
            activeInput = inputElement;
            const popupOverlay = document.getElementById(`${type}PopupOverlay`);
            const listContainer = document.getElementById(`${type}List`);
            const allParticipants = allParticipantsInput.split(',').map(name => name.trim()).filter(name => name.length > 0);
            
            listContainer.innerHTML = '';
            
            if (type === 'payerName') {
                allParticipants.forEach(name => {
                    const listItem = document.createElement('div');
                    listItem.className = 'popup-list-item';
                    listItem.innerHTML = `<label>${name}</label>`;
                    listItem.onclick = () => selectPayerName(name);
                    listContainer.appendChild(listItem);
                });
            } else if (type === 'target') {
                const currentTargets = activeInput.value.split(',').map(s => {
                    const [name, ratio] = s.split(':').map(val => val.trim());
                    return { name: name, ratio: ratio };
                }).filter(s => s.name.length > 0);
                
                allParticipants.forEach(name => {
                    const isSelected = currentTargets.some(target => target.name === name);
                    const currentRatio = isSelected ? (currentTargets.find(target => target.name === name).ratio || '') : '';
                    
                    const listItem = document.createElement('div');
                    listItem.className = `target-item ${isSelected ? 'selected' : ''}`;
                    listItem.innerHTML = `
                        <input type="checkbox" id="target-${name}" value="${name}" ${isSelected ? 'checked' : ''}>
                        <label for="target-${name}">${name}</label>
                        <input type="number" class="target-ratio" placeholder="비율 (%)" min="0" max="100" value="${currentRatio}">
                    `;
                    
                    const checkbox = listItem.querySelector('input[type="checkbox"]');
                    const ratioInput = listItem.querySelector('input[type="number"]');

                    checkbox.addEventListener('change', (e) => {
                        listItem.classList.toggle('selected', e.target.checked);
                    });

                    listContainer.appendChild(listItem);
                });
            }
            
            popupOverlay.classList.add('visible');
        }

        /**
         * 팝업을 숨깁니다.
         * @param {string} type - 'payerName' 또는 'target'
         */
        function hidePopup(type) {
            const popupOverlay = document.getElementById(`${type}PopupOverlay`);
            popupOverlay.classList.remove('visible');
            activeInput = null;
        }

        /**
         * 지불자 이름을 선택하고 팝업을 숨깁니다.
         * @param {string} name - 선택된 이름
         */
        function selectPayerName(name) {
            if (activeInput) {
                activeInput.value = name;
                hidePopup('payerName');
            }
        }
        
        /**
         * 대상 인원 선택을 완료하고 입력 필드를 업데이트합니다.
         */
        function selectTargets() {
            if (!activeInput) return;

            const targetListItems = document.querySelectorAll('#targetList .target-item');
            const selectedTargets = [];
            
            targetListItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const ratioInput = item.querySelector('input[type="number"]');

                if (checkbox.checked) {
                    const name = checkbox.value;
                    let value = name;
                    const ratio = ratioInput.value.trim();
                    if (ratio && !isNaN(parseFloat(ratio)) && parseFloat(ratio) > 0) {
                        value += `:${ratio}`;
                    }
                    selectedTargets.push(value);
                }
            });

            activeInput.value = selectedTargets.join(', ');
            hidePopup('target');
        }
        
        /**
         * 정산을 계산하는 메인 함수.
         * 모든 동적 입력값을 읽어 잔액을 계산하고 정산 내역을 표시합니다.
         */
        function calculate() {
            const allParticipantsInput = document.getElementById('allParticipants').value.trim();
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            
            // 결과 영역 초기화
            resultDiv.innerHTML = `<p>결과가 여기에 표시됩니다.</p>`;
            // 기존에 있던 버튼 및 메시지 제거
            const existingActions = resultContainer.querySelector('.result-actions');
            const existingStatus = resultContainer.querySelector('#copy-status');
            if (existingActions) existingActions.remove();
            if (existingStatus) existingStatus.remove();
            
            const errors = [];
            let allParticipants = [];
            if (allParticipantsInput) {
                allParticipants = allParticipantsInput.split(',').map(name => name.trim()).filter(name => name.length > 0);
            }
            
            if (allParticipants.length === 0) {
                errors.push('전체 참여자 이름을 한 명 이상 입력해주세요.');
            }
            
            // --- 유효성 검증 추가: 중복된 참여자 이름 확인 ---
            const uniqueParticipants = new Set(allParticipants);
            if (uniqueParticipants.size !== allParticipants.length) {
                const duplicates = allParticipants.filter((item, index) => allParticipants.indexOf(item) !== index);
                const uniqueDuplicates = [...new Set(duplicates)];
                errors.push(`중복된 참여자 이름이 있습니다: <b>${uniqueDuplicates.join(', ')}</b>`);
            }
            // --------------------------------------------------

            const payerInputs = document.querySelectorAll('.payer-input-group');
            const payments = [];
            
            for (const inputDiv of payerInputs) {
                const name = inputDiv.querySelector('.payer-name').value.trim();
                const amount = parseInt(inputDiv.querySelector('.payer-amount').value);
                const targetString = inputDiv.querySelector('.payer-target').value.trim();

                if (!name) {
                    errors.push('지불자의 이름을 선택해주세요.');
                }
                if (isNaN(amount) || amount < 0) {
                    errors.push(`<b>${name || '익명'}</b>의 금액을 올바르게 입력해주세요.`);
                }
                
                payments.push({
                    name: name,
                    amount: amount,
                    targetString: targetString
                });
            }

            if (payments.length === 0) {
                errors.push('최소 한 명의 지불자를 추가하고 정보를 입력해주세요.');
            }
            
            if (errors.length > 0) {
                let errorHtml = '<p class="error-message"><b>계산 오류:</b></p><ul>';
                errors.forEach(err => {
                    errorHtml += `<li>${err}</li>`;
                });
                errorHtml += '</ul>';
                resultDiv.innerHTML = errorHtml;
                return;
            }

            // 모든 참여자 목록을 기반으로 계산을 시작
            const finalParticipants = allParticipants;

            // 각 지출에 대한 개인별 분담금액을 계산하는 1차 행렬 (Matrix 1)
            const matrix1 = {};
            finalParticipants.forEach(p1 => {
                matrix1[p1] = {};
                finalParticipants.forEach(p2 => {
                    matrix1[p1][p2] = 0;
                });
            });

            payments.forEach(p => {
                if (p.targetString.includes(':')) {
                    const targetParts = p.targetString.split(',').map(s => s.trim());
                    const parsedTargets = {};
                    let totalPercentage = 0;
                    const peopleForRemainingSplit = [];
                    
                    for (const part of targetParts) {
                        const [targetName, ratio] = part.split(':').map(s => s.trim());
                        if (targetName) {
                            if(!isNaN(parseFloat(ratio))){
                                parsedTargets[targetName] = parseFloat(ratio);
                                totalPercentage += parseFloat(ratio);
                            } else {
                                peopleForRemainingSplit.push(targetName);
                            }
                        }
                    }

                    for (const name in parsedTargets) {
                        const cost = p.amount * (parsedTargets[name] / 100);
                        if (finalParticipants.includes(name)) {
                            matrix1[p.name][name] += cost;
                        }
                    }

                    const remainingAmount = p.amount * (1 - totalPercentage / 100);
                    
                    if (peopleForRemainingSplit.length > 0) {
                        const validRemainingPeople = peopleForRemainingSplit.filter(person => finalParticipants.includes(person));
                        if (validRemainingPeople.length > 0) {
                            const costPerRemainingHead = remainingAmount / validRemainingPeople.length;
                            validRemainingPeople.forEach(personName => {
                                matrix1[p.name][personName] += costPerRemainingHead;
                            });
                        }
                    }
                } else {
                    const targetParts = p.targetString.split(',').map(s => s.trim());
                    const effectiveTargets = targetParts.filter(s => s.length > 0);
                    
                    let peopleToCharge;
                    if (effectiveTargets.length > 0) {
                        peopleToCharge = effectiveTargets.filter(person => finalParticipants.includes(person));
                    } else {
                        peopleToCharge = finalParticipants;
                    }
                    
                    if (peopleToCharge.length > 0) {
                        const costPerHead = p.amount / peopleToCharge.length;
                        peopleToCharge.forEach(personName => {
                            matrix1[p.name][personName] += costPerHead;
                        });
                    }
                }
            });

            // 최종 정산 행렬 (Matrix 2)
            const matrix2 = {};
            finalParticipants.forEach(p1 => {
                matrix2[p1] = {};
                finalParticipants.forEach(p2 => {
                    const value = (matrix1[p2][p1] || 0) - (matrix1[p1][p2] || 0);
                    matrix2[p1][p2] = Math.max(0, value);
                });
            });

            // 결과 HTML 생성
            let resultHTML = '<h3>각 지출에 대한 개인별 분담금액 (Matrix 1)</h3>';
            resultHTML += '<p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">행(Beneficiary)이 열(Payer)에게 갚아야 할 금액</p>'
            resultHTML += '<table style="width:100%; border-collapse: collapse; text-align: center;" id="matrix1">';
            resultHTML += '<thead><tr><th style="padding: 8px; border: 1px solid #ddd;"></th>' + finalParticipants.map(p => `<th style="padding: 8px; border: 1px solid #ddd;">${p}</th>`).join('') + '</tr></thead>';
            resultHTML += '<tbody>';
            finalParticipants.forEach(rowP => {
                const sanitizedRowP = getSanitizedName(rowP);
                resultHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;"><b>${rowP}</b></td>`;
                finalParticipants.forEach(colP => {
                    const sanitizedColP = getSanitizedName(colP);
                    resultHTML += `<td id="matrix1-cell-${sanitizedRowP}-${sanitizedColP}" style="padding: 8px; border: 1px solid #ddd;">${Math.round(matrix1[colP][rowP] || 0).toLocaleString()}</td>`;
                });
                resultHTML += '</tr>';
            });
            resultHTML += '</tbody></table>';

            resultHTML += '<h3 style="margin-top:20px;">최종 정산 행렬 (Matrix 2)</h3>';
            resultHTML += '<p style="font-size: 0.8rem; color: #64748b; margin-bottom: 10px;">행(Payer)이 열(Receiver)에게 줘야 할 최종 금액</p>'
            resultHTML += '<table style="width:100%; border-collapse: collapse; text-align: center;" id="matrix2">';
            resultHTML += '<thead><tr><th style="padding: 8px; border: 1px solid #ddd;"></th>' + finalParticipants.map(p => `<th style="padding: 8px; border: 1px solid #ddd;">${p}</th>`).join('') + '</tr></thead>';
            resultHTML += '<tbody>';
            finalParticipants.forEach((rowP) => {
                resultHTML += `<tr><td style="padding: 8px; border: 1px solid #ddd;"><b>${rowP}</b></td>`;
                finalParticipants.forEach((colP) => {
                    const amount = Math.round(matrix2[rowP][colP]);
                    const cellAttributes = `data-row="${rowP}" data-col="${colP}"`;
                    const cellStyle = amount > 0 ? `cursor: pointer;` : '';
                    resultHTML += `<td ${cellAttributes} style="padding: 8px; border: 1px solid #ddd;${cellStyle}">${amount.toLocaleString()}</td>`;
                });
                resultHTML += '</tr>';
            });
            resultHTML += '</tbody></table>';

            resultHTML += '<h3 style="margin-top:20px;">최종 정산 결과</h3><ul>';
            let transactionsExist = false;
            finalParticipants.forEach(fromP => {
                finalParticipants.forEach(toP => {
                    const amount = Math.round(matrix2[fromP][toP]);
                    if (amount > 0) {
                        resultHTML += `<li><b>${fromP}</b> &gt; <b>${toP}</b> ${amount.toLocaleString()}원</li>`;
                        transactionsExist = true;
                    }
                });
            });

            if (!transactionsExist) {
                resultHTML += '<li>정산할 금액이 없습니다.</li>';
            }
            resultHTML += '</ul>';

            resultDiv.innerHTML = resultHTML;

            const resultActionsDiv = document.createElement('div');
            resultActionsDiv.className = 'result-actions';
            
            const downloadButton = document.createElement('button');
            downloadButton.className = 'button secondary-button';
            downloadButton.textContent = '이미지로 저장';
            downloadButton.onclick = downloadResultAsImage;
            
            const copyTextButton = document.createElement('button');
            copyTextButton.className = 'button secondary-button';
            copyTextButton.textContent = '정산 결과 텍스트 복사';
            copyTextButton.onclick = copyResultAsText;

            const statusMessage = document.createElement('p');
            statusMessage.id = 'copy-status';
            statusMessage.className = 'status-message';
            
            resultActionsDiv.appendChild(downloadButton);
            resultActionsDiv.appendChild(copyTextButton);
            resultContainer.appendChild(resultActionsDiv);
            resultContainer.appendChild(statusMessage);

            const matrix2Table = document.getElementById('matrix2');
            if (matrix2Table) {
                matrix2Table.addEventListener('mouseover', handleMouseOver);
                matrix2Table.addEventListener('mouseout', handleMouseOut);
            }
        }

        // 초기 지불자 입력란 추가
        addPayer();
    </script>
</body>
</html>
